<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fake Job Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-200 to-purple-200 min-h-screen flex flex-col">
    <div class="flex-1 flex items-center justify-center p-8">
        <div class="max-w-6xl w-full mx-auto bg-white shadow-xl rounded-lg p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold text-purple-700">AI Fake Job Detection</h1>
                <div class="flex gap-3">
                    <!-- Import Button -->
                    <button id="importBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Import <span style="font-size: 10px;">by AI</span></button>
                    <a href="/admin" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Admin Dashboard</a>
                </div>
            </div>

            <!-- Import Text Box (Hidden by default) -->
            <div id="importContainer" class="mb-6 bg-gray-100 p-4 rounded-lg hidden">
                <div class="flex items-start gap-3">
                    <textarea id="importText" class="flex-1 p-3 border rounded shadow-sm" rows="3" placeholder="Paste job listing data here..."></textarea>
                    <button id="confirmImportBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Confirm</button>
                </div>
            </div>
            
            <p class="text-gray-600 mb-6">Enter job listing details to analyze potential fraud indicators.</p>
            
            <!-- Job Input Form -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block font-medium">Job Title</label>
                    <input type="text" id="title" class="w-full p-3 border rounded shadow-sm">
                </div>
                <div>
                    <label class="block font-medium">Company Name</label>
                    <input type="text" id="company" class="w-full p-3 border rounded shadow-sm">
                </div>
                <div class="col-span-1 lg:col-span-2">
                    <label class="block font-medium">Job Description</label>
                    <textarea id="description" class="w-full p-3 border rounded shadow-sm" rows="3"></textarea>
                </div>
                <div>
                    <label class="block font-medium">Salary/month</label>
                    <input type="number" id="salary" class="w-full p-3 border rounded shadow-sm">
                </div>
                <div>
                    <label class="block font-medium">Contact Email</label>
                    <input type="email" id="email" class="w-full p-3 border rounded shadow-sm">
                </div>
                <div class="col-span-1 lg:col-span-2">
                    <label class="block font-medium">Job Requirements</label>
                    <textarea id="requirements" class="w-full p-3 border rounded shadow-sm" rows="3"></textarea>
                </div>
            </div>
            
            <button id="analyzeBtn" class="w-full bg-purple-600 text-white p-3 rounded hover:bg-purple-700 flex items-center justify-center">
                <span>Analyze Job Listing</span>
                <span id="loading" class="ml-2 hidden animate-spin">⏳</span>
            </button>

            <!-- Analysis Results -->
            <div id="analysisResults" class="bg-gray-100 p-6 rounded-lg hidden mt-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    Analysis Results <span id="riskIcon"></span>
                </h2>
                <p id="timestamp" class="text-gray-600"></p>
                <div id="alertContainer" class="p-4 rounded mt-4">
                    <h3 id="riskLevel" class="font-bold"></h3>
                    <ul id="risksList" class="list-disc pl-4"></ul>
                </div>
                <p class="text-sm text-gray-500">Note: This is an automated analysis with realtime updated database.</p>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Import button click handler
            $('#importBtn').click(function() {
                $('#importContainer').toggleClass('hidden');
            });

            // Confirm import button click handler
            $('#confirmImportBtn').click(function() {
                const importedText = $('#importText').val();

                if (!importedText || importedText.trim().length < 50) {
                    alert('Please enter a longer job description for accurate parsing.');
                    return;
                }

                // Show loading indicator
                $(this).html('<span class="animate-spin inline-block mr-2">⏳</span> Processing...');
                $(this).prop('disabled', true);

                // Call the backend API to process the text
                $.ajax({
                    url: '/import-job-text',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ text: importedText }),
                    success: function(response) {
                        if (response.success && response.data) {
                            // Populate form fields with the parsed data
                            $('#title').val(response.data.title || '');
                            $('#company').val(response.data.company || '');
                            $('#description').val(response.data.description || '');
                            $('#salary').val(response.data.salary || '');
                            $('#email').val(response.data.email || '');
                            $('#requirements').val(response.data.requirements || '');

                            // Show success message
                            // alert('Job listing imported successfully!');
                        } else {
                            alert('Could not parse job listing. Please try manual entry.');
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Failed to process the job listing.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    },
                    complete: function() {
                        // Reset button state
                        $('#confirmImportBtn').html('Confirm');
                        $('#confirmImportBtn').prop('disabled', false);

                        // Hide the import container
                        $('#importContainer').addClass('hidden');
                        // Clear the import text area
                        $('#importText').val('');
                    }
                });
            });    
            
            // Analyze button click handler
            $('#analyzeBtn').click(function() {
                $('#loading').removeClass('hidden');
                
                const jobDetails = {
                    title: $('#title').val(),
                    company: $('#company').val(),
                    description: $('#description').val(),
                    salary: $('#salary').val(),
                    email: $('#email').val(),
                    requirements: $('#requirements').val()
                };

                $.ajax({
                    url: '/analyze',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(jobDetails),
                    success: function(response) {
                        $('#loading').addClass('hidden');
                        
                        // Access the nested data object from the response
                        const analysis = response.data;
                        
                        $('#timestamp').text('Analysis completed at ' + analysis.timestamp);
                        $('#riskLevel').text('Risk Level: ' + analysis.risk_level.toUpperCase());
                        
                        const riskColors = {
                            'high': 'text-red-600 bg-red-100',
                            'medium': 'text-yellow-600 bg-yellow-100',
                            'low': 'text-green-600 bg-green-100'
                        };
                        $('#alertContainer').attr('class', `p-4 rounded mt-4 ${riskColors[analysis.risk_level]}`);
                        
                        const riskIcons = {
                            'high': '⚠️⚠️',
                            'medium': '⚠️',
                            'low': '✅'
                        };
                        $('#riskIcon').html(`<span>${riskIcons[analysis.risk_level]}</span>`);
                        
                        $('#risksList').empty();
                        if (analysis.risks.length > 0) {
                            analysis.risks.forEach(risk => {
                                $('#risksList').append(`<li>${risk}</li>`);
                            });
                        } else {
                            $('#risksList').append('<li>No risk indicators detected. This job listing appears legitimate.</li>');
                        }
                        
                        $('#analysisResults').removeClass('hidden');
                        
                        // Scroll to the analysis results with smooth animation
                        $('html, body').animate({
                            scrollTop: $('#analysisResults').offset().top
                        }, 800);
                    },
                    error: function(xhr) {
                        $('#loading').addClass('hidden');
                        if (xhr.responseJSON && xhr.responseJSON.errors) {
                            alert('Validation errors: ' + xhr.responseJSON.errors.join('\n'));
                        } else {
                            alert('Unable to connect to the server. Please try again later.');
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>